<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>acuity_de_batchingservice.batching.batching_main &mdash; Batch Monitor 1.0.0.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Batch Monitor
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#batch-monitoring-flow">Batch Monitoring Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#installing-dependent-modules">Installing Dependent Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">acuity_de_batchingservice</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Batch Monitor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">acuity_de_batchingservice.batching.batching_main</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for acuity_de_batchingservice.batching.batching_main</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;/batching_code&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">acuity_de_batchingservice.commons.log4j_logger</span> <span class="k">as</span> <span class="nn">log4j_logger</span>
<span class="c1">#import acuity_de_batchingservice.commons.json_validator as validate_json</span>
<span class="kn">import</span> <span class="nn">acuity_de_batchingservice.commons.consume_batch</span> <span class="k">as</span> <span class="nn">cb</span>
<span class="c1">#import acuity_de_batchingservice.commons.gen_dml_strings as gen_dml</span>
<span class="kn">import</span> <span class="nn">acuity_de_batchingservice.commons.connect_pg</span> <span class="k">as</span> <span class="nn">pg</span>
<span class="kn">import</span> <span class="nn">acuity_de_batchingservice.commons.CONSTANTS</span> <span class="k">as</span> <span class="nn">CONSTANTS</span>
<span class="kn">import</span> <span class="nn">acuity_de_batchingservice.commons.trigger_workflow</span> <span class="k">as</span> <span class="nn">trigger_wf</span>
<span class="kn">import</span> <span class="nn">acuity_de_batchingservice.commons.chk_excp</span> <span class="k">as</span> <span class="nn">chk_excp</span>
<span class="kn">from</span> <span class="nn">acuity_de_batchingservice.commons.publish_sqs</span> <span class="kn">import</span> <span class="n">publish_sqs</span> <span class="k">as</span> <span class="n">publish_sqs</span> 

<span class="n">my_debug</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="batching_main"><a class="viewcode-back" href="../../../acuity_de_batchingservice.batching.html#acuity_de_batchingservice.batching.batching_main.batching_main">[docs]</a><span class="k">def</span> <span class="nf">batching_main</span><span class="p">():</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">log4j_logger</span><span class="o">.</span><span class="n">Log4j</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span> 
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONSUME_SLEEPTIME</span><span class="p">)</span>
            <span class="n">json_msg_array</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">consume_batch</span><span class="o">.</span><span class="n">consume_sqs</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCHING_QUEUE_NAME</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">json_msg_array</span><span class="p">:</span>
                <span class="n">v_json_msg</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_msg_array</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Body&#39;</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">v_json_msg</span><span class="p">)</span>
                
                <span class="n">v_table_nm</span><span class="o">=</span><span class="n">v_json_msg</span><span class="p">[</span><span class="s1">&#39;tableName&#39;</span><span class="p">]</span>
                <span class="n">v_batch_txn_data_extract_dt</span><span class="o">=</span><span class="n">v_json_msg</span><span class="p">[</span><span class="s1">&#39;extracttimestamp&#39;</span><span class="p">]</span>
                <span class="n">v_tenant_nm</span><span class="o">=</span><span class="n">v_json_msg</span><span class="p">[</span><span class="s1">&#39;tenantNm&#39;</span><span class="p">]</span>
                <span class="n">v_meta_schema</span> <span class="o">=</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">GIA_METADATA_SCHEMA_PREFIX</span> <span class="o">+</span> <span class="n">v_tenant_nm</span> 
                <span class="n">v_bc</span> <span class="o">=</span>  <span class="n">v_meta_schema</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_CONFIG_TABLE</span>
                <span class="n">v_bcd</span> <span class="o">=</span>  <span class="n">v_meta_schema</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_CONFIG_DTL_TABLE</span>
                <span class="n">v_bt</span> <span class="o">=</span>  <span class="n">v_meta_schema</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_TABLE</span>
                <span class="n">v_btd</span> <span class="o">=</span>  <span class="n">v_meta_schema</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_DTL_TABLE</span>

                <span class="n">meta_query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;select bcd.batch_config_dtl_sk, bcd.batch_config_dtl_src_file_nm, bc.batch_config_sk, bc.tenant_cd, bc.batch_config_nm, bc.batch_config_desc,</span>
<span class="s1">                        bc.batch_config_cnt, bc.batch_config_sngl_file_ind, bc.batch_config_freq_hour, bc.batch_config_sla_hour, bc.lob_sk, bc.batch_config_sts_sk,</span>
<span class="s1">                        bc.batch_config_load_prcss_nm_sk, bc.batch_config_trgt_app, bc.batch_config_trgt_obj_nm, bc.batch_config_trgt_scrpt, bc.batch_config_alert_email_list, bc.batch_config_excp_chk_ind</span>
<span class="s1">                FROM </span><span class="si">{}</span><span class="s1"> bcd</span>
<span class="s1">                join </span><span class="si">{}</span><span class="s1"> bc</span>
<span class="s1">                on bcd.batch_config_sk = bc.batch_config_sk</span>
<span class="s1">                where bcd.batch_config_dtl_src_file_nm = &#39;</span><span class="si">{}</span><span class="s1">&#39;</span>
<span class="s1">                and bc.batch_config_sts_sk = </span><span class="si">{}</span><span class="s1"> &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bcd</span><span class="p">,</span> <span class="n">v_bc</span><span class="p">,</span> <span class="n">v_table_nm</span><span class="p">,</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONFIG_STS_ACTIVE</span><span class="p">)</span>

                <span class="c1"># Metadata lookup using the fetch_metadata function</span>
                <span class="n">meta_dict</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">meta_query</span><span class="p">)</span>
            

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_dict</span><span class="p">)</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">meta_rec</span> <span class="ow">in</span> <span class="n">meta_dict</span><span class="p">:</span>
<span class="w">                        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                        meta_query to verify if an open batch transaction exists in batch_txn_dtl or batch_txn tables</span>
<span class="sd">                        for the given window</span>
<span class="sd">                        &#39;&#39;&#39;</span>
                        <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------Round - </span><span class="si">{}</span><span class="s1">--------&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meta_dict</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">meta_rec</span><span class="p">)))</span>

                        <span class="c1"># Fetching max Batch transaction records for each config from metadata for the received source table </span>
                        <span class="n">max_batch_rec_query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;select bt.batch_txn_sk, bt.batch_config_sk, bt.batch_txn_sts_sk, bt.batch_txn_wndw_bgn_dt, bt.batch_txn_wndw_end_dt, </span>
<span class="s1">                                                bt.batch_txn_expct_file_cnt, bt.batch_txn_recv_file_cnt, bt.batch_txn_excp_rsn_sk, bc.batch_config_freq_hour,</span>
<span class="s1">                                                case when bt.batch_txn_sts_sk = </span><span class="si">{txn_sts_comp}</span><span class="s1"> then bt.batch_txn_wndw_end_dt + interval &#39;1 sec&#39; </span>
<span class="s1">                                                    else bt.batch_txn_wndw_bgn_dt end as new_wndw_bgn_dt</span>
<span class="s1">                                                , case when bt.batch_txn_sts_sk = </span><span class="si">{txn_sts_comp}</span><span class="s1"> then bt.batch_txn_wndw_end_dt + interval &#39;1 sec&#39; * (bc.batch_config_freq_hour * 3600 )  </span>
<span class="s1">                                                else bt.batch_txn_wndw_end_dt end as new_wndw_end_dt</span>
<span class="s1">                                                from </span><span class="si">{}</span><span class="s1"> bt inner join </span><span class="si">{}</span><span class="s1"> bc on bt.batch_config_sk = bc.batch_config_sk where batch_txn_sk = </span>
<span class="s1">                        (</span>
<span class="s1">                            select max(batch_txn_sk)</span>
<span class="s1">                            from </span><span class="si">{}</span>
<span class="s1">                            where batch_config_sk = </span><span class="si">{}</span>
<span class="s1">                            and batch_txn_sts_sk != </span><span class="si">{}</span>
<span class="s1">                        )&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bt</span><span class="p">,</span> <span class="n">v_bc</span><span class="p">,</span> <span class="n">v_bt</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s2">&quot;batch_config_sk&quot;</span><span class="p">],</span> 
                                    <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_FAIL</span><span class="p">,</span> <span class="n">txn_sts_comp</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_COMPLETED</span><span class="p">)</span>
                        <span class="n">max_batch_rec_list</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">max_batch_rec_query</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">max_batch_rec_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">max_batch_rec_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_sts_sk&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_COMPLETED</span><span class="p">:</span>
                                <span class="c1"># Checking the exception scenarios for this message</span>
                                <span class="n">v_batch_txn_excp_list</span> <span class="o">=</span> <span class="n">chk_excp</span><span class="o">.</span><span class="n">check_exception</span><span class="p">(</span><span class="n">meta_rec</span><span class="p">,</span> <span class="n">v_json_msg</span><span class="p">,</span> <span class="n">max_batch_rec_list</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_batch_txn_excp_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">v_batch_txn_excp_rsn_sk</span> <span class="o">=</span> <span class="n">v_batch_txn_excp_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">v_batch_txn_excp_rsn_msg</span> <span class="o">=</span> <span class="n">v_batch_txn_excp_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;Error while checking the Exception process&#39;</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                                    <span class="c1">### TODO Call Control Service</span>
                                    <span class="n">ctrl_msg</span> <span class="o">=</span> <span class="n">publish_sqs</span><span class="o">.</span><span class="n">gen_msg</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">,</span> <span class="n">v_json_msg</span><span class="p">,</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">TECH_ERROR</span><span class="p">,</span> <span class="n">err_msg</span><span class="p">)</span>
                                    <span class="n">ctrl_resp</span> <span class="o">=</span> <span class="n">publish_sqs</span><span class="o">.</span><span class="n">pub_sqs</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL_QUEUE_NAME</span><span class="p">,</span> <span class="n">ctrl_msg</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">ctrl_resp</span><span class="p">[</span><span class="s1">&#39;ResponseMetadata&#39;</span><span class="p">][</span><span class="s1">&#39;HTTPStatusCode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error while sending message to Control Service queue:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL_QUEUE_NAME</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">v_batch_txn_excp_rsn_sk</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_EXCP_RSN_PREV_WIN</span><span class="p">,</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_EXCP_RSN_DUP</span><span class="p">]:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="n">v_batch_txn_excp_rsn_msg</span><span class="p">)</span>
                                    <span class="n">ins_batch_txn</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;insert into </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                                    ( batch_config_sk, batch_txn_sts_sk, batch_txn_data_extract_dt, batch_txn_wndw_bgn_dt, batch_txn_wndw_end_dt, </span>
<span class="s1">                                                    batch_txn_expct_file_cnt, batch_txn_recv_file_cnt, batch_txn_excp_rsn_sk, batch_txn_trgr_sts_cd_sk, batch_txn_max_wait_hours)</span>
<span class="s1">                                                    select </span><span class="si">{}</span><span class="s1">, </span><span class="si">{txn_sts}</span><span class="s1">, &#39;</span><span class="si">{}</span><span class="s1">&#39;,  &#39;</span><span class="si">{}</span><span class="s1">&#39;, &#39;</span><span class="si">{}</span><span class="s1">&#39;,</span><span class="si">{}</span><span class="s1">, </span>
<span class="s1">                                                    1, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                                    &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bt</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sk&#39;</span><span class="p">],</span> <span class="n">v_batch_txn_data_extract_dt</span><span class="p">,</span> <span class="n">max_batch_rec_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;new_wndw_bgn_dt&#39;</span><span class="p">],</span> 
                                                    <span class="n">max_batch_rec_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;new_wndw_end_dt&#39;</span><span class="p">],</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_cnt&#39;</span><span class="p">],</span> <span class="n">v_batch_txn_excp_rsn_sk</span><span class="p">,</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_TRGR_STS_FAIL</span><span class="p">,</span>
                                                    <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sla_hour&#39;</span><span class="p">],</span> <span class="n">txn_sts</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_FAIL</span><span class="p">)</span>
                                    <span class="n">ins_batch_txn_dtl</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;INSERT INTO </span><span class="si">{}</span><span class="s1"> ( batch_config_dtl_sk, batch_txn_sk, batch_config_sk, batch_txn_dtl_sts_sk, batch_txn_json_dtl, batch_txn_dtl_excp_rsn_sk)</span>
<span class="s1">                                                        select </span><span class="si">{}</span><span class="s1">, max(batch_txn_sk), </span><span class="si">{config_sk}</span><span class="s1">, </span><span class="si">{txn_sts_fail}</span><span class="s1">, cast(&#39;</span><span class="si">{}</span><span class="s1">&#39; as json ), </span><span class="si">{}</span><span class="s1"> from </span><span class="si">{}</span><span class="s1"> where batch_config_sk = </span><span class="si">{config_sk}</span><span class="s1"> and </span>
<span class="s1">                                                        batch_txn_sts_sk = </span><span class="si">{txn_sts_fail}</span><span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_btd</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_dtl_sk&#39;</span><span class="p">],</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">v_json_msg</span><span class="p">),</span> <span class="n">v_batch_txn_excp_rsn_sk</span><span class="p">,</span> 
                                                                                            <span class="n">v_bt</span><span class="p">,</span> <span class="n">txn_sts_fail</span> <span class="o">=</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_FAIL</span> <span class="p">,</span> <span class="n">config_sk</span><span class="o">=</span><span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sk&#39;</span><span class="p">]</span> <span class="p">)</span>
                                    <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">ins_batch_txn</span><span class="p">)</span>
                                    <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">ins_batch_txn_dtl</span><span class="p">)</span>
                                    <span class="c1">### TODO Call Control Service</span>
                                    <span class="n">ctrl_msg</span> <span class="o">=</span> <span class="n">publish_sqs</span><span class="o">.</span><span class="n">gen_msg</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">,</span> <span class="n">v_json_msg</span><span class="p">,</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">TECH_ERROR</span><span class="p">,</span> <span class="n">v_batch_txn_excp_rsn_msg</span><span class="p">)</span>
                                    <span class="n">ctrl_resp</span> <span class="o">=</span> <span class="n">publish_sqs</span><span class="o">.</span><span class="n">pub_sqs</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL_QUEUE_NAME</span><span class="p">,</span> <span class="n">ctrl_msg</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">ctrl_resp</span><span class="p">[</span><span class="s1">&#39;ResponseMetadata&#39;</span><span class="p">][</span><span class="s1">&#39;HTTPStatusCode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error while sending message to Control Service queue:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL_QUEUE_NAME</span><span class="p">))</span>
                                    <span class="k">continue</span>
                                <span class="k">elif</span> <span class="n">v_batch_txn_excp_rsn_sk</span> <span class="o">==</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_EXCP_RSN_FUT_WIN</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="n">v_batch_txn_excp_rsn_msg</span><span class="p">)</span>
                                    <span class="n">pub_batch_resp</span> <span class="o">=</span> <span class="n">publish_sqs</span><span class="o">.</span><span class="n">pub_sqs</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCHING_QUEUE_NAME</span><span class="p">,</span> <span class="n">v_json_msg</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">pub_batch_resp</span><span class="p">[</span><span class="s1">&#39;ResponseMetadata&#39;</span><span class="p">][</span><span class="s1">&#39;HTTPStatusCode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                                        <span class="n">pub_batch_resp_msg</span> <span class="o">=</span> <span class="s1">&#39;Failed to send message back to queue to process in correct order, error_code:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pub_batch_resp</span><span class="p">[</span><span class="s1">&#39;ResponseMetadata&#39;</span><span class="p">][</span><span class="s1">&#39;HTTPStatusCode&#39;</span><span class="p">])</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="n">pub_batch_resp_msg</span><span class="p">)</span>
                                        <span class="c1"># TODO Call Control Service</span>
                                        <span class="n">ctrl_msg</span> <span class="o">=</span> <span class="n">publish_sqs</span><span class="o">.</span><span class="n">gen_msg</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">,</span> <span class="n">v_json_msg</span><span class="p">,</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">QUEUE_ERROR</span><span class="p">,</span> <span class="n">pub_batch_resp_msg</span><span class="p">)</span>
                                        <span class="n">ctrl_resp</span> <span class="o">=</span> <span class="n">publish_sqs</span><span class="o">.</span><span class="n">pub_sqs</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL_QUEUE_NAME</span><span class="p">,</span> <span class="n">ctrl_msg</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">ctrl_resp</span><span class="p">[</span><span class="s1">&#39;ResponseMetadata&#39;</span><span class="p">][</span><span class="s1">&#39;HTTPStatusCode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error while sending message to Control Service queue:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL_QUEUE_NAME</span><span class="p">))</span>
                                    <span class="k">continue</span>
                                <span class="k">elif</span> <span class="n">v_batch_txn_excp_rsn_sk</span> <span class="o">==</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_EXCP_RSN_NE</span><span class="p">:</span>
                                    <span class="c1"># The max record for this config in the batch transaction table is in completion status and no exceptions</span>
                                    <span class="c1"># hence inserting new batch and batch transaction entries</span>
                                    <span class="n">ins_batch_txn</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;insert into </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                                    ( batch_config_sk, batch_txn_sts_sk, batch_txn_data_extract_dt, batch_txn_wndw_bgn_dt, batch_txn_wndw_end_dt, </span>
<span class="s1">                                                    batch_txn_expct_file_cnt, batch_txn_recv_file_cnt, batch_txn_excp_rsn_sk, batch_txn_trgr_sts_cd_sk, batch_txn_max_wait_hours)</span>
<span class="s1">                                                    select </span><span class="si">{}</span><span class="s1">, </span><span class="si">{txn_sts_open}</span><span class="s1">, &#39;</span><span class="si">{}</span><span class="s1">&#39;,  &#39;</span><span class="si">{}</span><span class="s1">&#39;, &#39;</span><span class="si">{}</span><span class="s1">&#39;,</span><span class="si">{}</span><span class="s1">, </span>
<span class="s1">                                                    1, </span><span class="si">{}</span><span class="s1">, null, </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                                    &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bt</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sk&#39;</span><span class="p">],</span> <span class="n">v_batch_txn_data_extract_dt</span><span class="p">,</span> 
                                                               <span class="n">max_batch_rec_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;new_wndw_bgn_dt&#39;</span><span class="p">],</span> <span class="n">max_batch_rec_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;new_wndw_end_dt&#39;</span><span class="p">],</span> 
                                                               <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_cnt&#39;</span><span class="p">],</span> <span class="n">v_batch_txn_excp_rsn_sk</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sla_hour&#39;</span><span class="p">]</span>
                                                               <span class="p">,</span><span class="n">txn_sts_open</span> <span class="o">=</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_OPEN</span><span class="p">)</span>
                                    <span class="n">ins_batch_txn_dtl</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;INSERT INTO </span><span class="si">{}</span><span class="s1"> (</span>
<span class="s1">                                                        batch_config_dtl_sk, batch_txn_sk, batch_config_sk, batch_txn_dtl_sts_sk, batch_txn_json_dtl, batch_txn_dtl_excp_rsn_sk)</span>
<span class="s1">                                                        select </span><span class="si">{}</span><span class="s1">,(select max(batch_txn_sk) from </span><span class="si">{}</span><span class="s1"> where batch_config_sk = </span><span class="si">{}</span><span class="s1"> and batch_txn_sts_sk = </span><span class="si">{txn_sts_open}</span><span class="s1"> ),</span>
<span class="s1">                                                        </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, cast(&#39;</span><span class="si">{}</span><span class="s1">&#39; as json ), </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                                        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_btd</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_dtl_sk&#39;</span><span class="p">],</span> <span class="n">v_bt</span><span class="p">,</span> 
                                                                   <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sk&#39;</span><span class="p">],</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sk&#39;</span><span class="p">],</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_COMPLETED</span>
                                                                   <span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">v_json_msg</span><span class="p">),</span> <span class="n">v_batch_txn_excp_rsn_sk</span><span class="p">,</span><span class="n">txn_sts_open</span> <span class="o">=</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_OPEN</span> <span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;batch_txn insert query&#39;</span><span class="p">,</span> <span class="n">ins_batch_txn</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;batch_txn_dtl insert query&#39;</span><span class="p">,</span> <span class="n">ins_batch_txn_dtl</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                                <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">ins_batch_txn</span><span class="p">)</span>
                                <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">ins_batch_txn_dtl</span><span class="p">)</span>
                                <span class="c1">#print(ins_batch_txn_rec)</span>
                                <span class="n">ver_batch_txn_sts_query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;select * from </span><span class="si">{}</span><span class="s1"> where batch_txn_sk = (select max(batch_txn_sk) from </span><span class="si">{}</span><span class="s1"> where batch_config_sk = </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                and batch_txn_sts_sk = </span><span class="si">{txn_sts_open}</span><span class="s1"> )</span>
<span class="s1">                                &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bt</span><span class="p">,</span> <span class="n">v_bt</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sk&#39;</span><span class="p">],</span><span class="n">txn_sts_open</span> <span class="o">=</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_OPEN</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;batch verification query: &#39;</span><span class="p">,</span> <span class="n">ver_batch_txn_sts_query</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                                <span class="n">ver_batch_txn_sts_rec_dict</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">ver_batch_txn_sts_query</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Batch verification output dictionary&#39;</span><span class="p">,</span> <span class="n">ver_batch_txn_sts_rec_dict</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>

                                <span class="k">if</span> <span class="n">ver_batch_txn_sts_rec_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_expct_file_cnt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ver_batch_txn_sts_rec_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_recv_file_cnt&#39;</span><span class="p">]:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected number of files for this batch config is received. Trigger the target loads :&#39;</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_trgt_scrpt&#39;</span><span class="p">])</span>
                                    <span class="c1"># TODO Add step to verify the status of Target DBX workflow</span>
                                    <span class="n">trigger_res</span> <span class="o">=</span> <span class="n">trigger_wf</span><span class="o">.</span><span class="n">trigger_workflow</span><span class="o">.</span><span class="n">triggerJob</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">DATABRICKS_URL</span><span class="p">,</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">DATABRICKS_AT</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_trgt_scrpt&#39;</span><span class="p">])</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Databricks workflow trigger response :&quot;</span><span class="p">,</span> <span class="n">trigger_res</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">DATABRICKS_SUCC</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">trigger_res</span><span class="p">):</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sucessfully triggerred the workflow:&#39;</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_trgt_scrpt&#39;</span><span class="p">])</span>
                                        <span class="n">mark_batch_txn_completed_query</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;update </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                                        set batch_txn_sts_sk = </span><span class="si">{txn_sts_comp}</span><span class="s1">,</span>
<span class="s1">                                                        batch_txn_trgr_sts_cd_sk = </span><span class="si">{trgr_sts_succ}</span><span class="s1">,</span>
<span class="s1">                                                        batch_txn_excp_rsn_sk = </span><span class="si">{excp_rsn_ne}</span><span class="s1">,</span>
<span class="s1">                                                        upd_by_user_id = user,</span>
<span class="s1">                                                        upd_dttm = current_timestamp</span>
<span class="s1">                                                        where batch_txn_sk = </span><span class="si">{}</span>
<span class="s1">                                                        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bt</span><span class="p">,</span> <span class="n">ver_batch_txn_sts_rec_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_sk&#39;</span><span class="p">],</span> 
                                                                <span class="n">txn_sts_comp</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_COMPLETED</span><span class="p">,</span> 
                                                                <span class="n">trgr_sts_succ</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_TRGR_STS_SUCC</span><span class="p">,</span> <span class="n">excp_rsn_ne</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_EXCP_RSN_NE</span><span class="p">)</span>
                                        <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">mark_batch_txn_completed_query</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to trigger the workflow:&#39;</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_trgt_scrpt&#39;</span><span class="p">],</span> <span class="s1">&#39;marking the batch as failed&#39;</span><span class="p">)</span>
                                        <span class="n">mark_batch_txn_failed_query</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;update </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                                        set batch_txn_sts_sk = </span><span class="si">{txn_sts_fail}</span><span class="s1">,</span>
<span class="s1">                                                        batch_txn_trgr_sts_cd_sk = </span><span class="si">{trgr_sts_fail}</span><span class="s1">,</span>
<span class="s1">                                                        batch_txn_excp_rsn_sk = </span><span class="si">{excp_rsn_ne}</span><span class="s1">,</span>
<span class="s1">                                                        upd_by_user_id = user,</span>
<span class="s1">                                                        upd_dttm = current_timestamp</span>
<span class="s1">                                                        where batch_txn_sk = </span><span class="si">{}</span>
<span class="s1">                                                        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bt</span><span class="p">,</span> <span class="n">ver_batch_txn_sts_rec_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_sk&#39;</span><span class="p">],</span> 
                                                                <span class="n">txn_sts_fail</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_FAIL</span><span class="p">,</span> 
                                                                <span class="n">trgr_sts_fail</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_TRGR_STS_FAIL</span><span class="p">,</span> <span class="n">excp_rsn_ne</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_EXCP_RSN_NE</span><span class="p">)</span>
                                        <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">mark_batch_txn_failed_query</span><span class="p">)</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected number of files are not received yet, so this batch transaction will stay open&#39;</span><span class="p">)</span>
                                
                            <span class="k">elif</span> <span class="n">max_batch_rec_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_sts_sk&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_OPEN</span><span class="p">:</span>
                                <span class="c1">#The lastest batch is still open so we need to insert only batch transaction details table with this new file </span>
                                <span class="c1">#Update the existing batch transaction file count</span>
                                            
                                <span class="c1"># Checking the exception scenarios for this message</span>
                                <span class="n">v_batch_txn_excp_list</span> <span class="o">=</span> <span class="n">chk_excp</span><span class="o">.</span><span class="n">check_exception</span><span class="p">(</span><span class="n">meta_rec</span><span class="p">,</span> <span class="n">v_json_msg</span><span class="p">,</span> <span class="n">max_batch_rec_list</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_batch_txn_excp_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">v_batch_txn_excp_rsn_sk</span> <span class="o">=</span> <span class="n">v_batch_txn_excp_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">v_batch_txn_excp_rsn_msg</span> <span class="o">=</span> <span class="n">v_batch_txn_excp_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;Error while checking the Exception process&#39;</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                                    <span class="c1">### TODO Call Control Service</span>
                                    <span class="n">ctrl_msg</span> <span class="o">=</span> <span class="n">publish_sqs</span><span class="o">.</span><span class="n">gen_msg</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">,</span> <span class="n">v_json_msg</span><span class="p">,</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">QUEUE_ERROR</span><span class="p">,</span> <span class="n">err_msg</span><span class="p">)</span>
                                    <span class="n">ctrl_resp</span> <span class="o">=</span> <span class="n">publish_sqs</span><span class="o">.</span><span class="n">pub_sqs</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL_QUEUE_NAME</span><span class="p">,</span> <span class="n">ctrl_msg</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">ctrl_resp</span><span class="p">[</span><span class="s1">&#39;ResponseMetadata&#39;</span><span class="p">][</span><span class="s1">&#39;HTTPStatusCode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error while sending message to Control Service queue:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL_QUEUE_NAME</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">v_batch_txn_excp_rsn_sk</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_EXCP_RSN_PREV_WIN</span><span class="p">,</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_EXCP_RSN_DUP</span><span class="p">]:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="n">v_batch_txn_excp_rsn_msg</span><span class="p">)</span>
                                    <span class="n">ins_batch_txn</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;insert into </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                                    ( batch_config_sk, batch_txn_sts_sk, batch_txn_data_extract_dt, batch_txn_wndw_bgn_dt, batch_txn_wndw_end_dt, </span>
<span class="s1">                                                    batch_txn_expct_file_cnt, batch_txn_recv_file_cnt, batch_txn_excp_rsn_sk, batch_txn_trgr_sts_cd_sk, batch_txn_max_wait_hours)</span>
<span class="s1">                                                    select </span><span class="si">{}</span><span class="s1">, </span><span class="si">{txn_sts}</span><span class="s1">, &#39;</span><span class="si">{}</span><span class="s1">&#39;,  &#39;</span><span class="si">{}</span><span class="s1">&#39;, &#39;</span><span class="si">{}</span><span class="s1">&#39;,</span><span class="si">{}</span><span class="s1">, </span>
<span class="s1">                                                    1, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                                    &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bt</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sk&#39;</span><span class="p">],</span> <span class="n">v_batch_txn_data_extract_dt</span><span class="p">,</span> <span class="n">max_batch_rec_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;new_wndw_bgn_dt&#39;</span><span class="p">],</span> 
                                                    <span class="n">max_batch_rec_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;new_wndw_end_dt&#39;</span><span class="p">],</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_cnt&#39;</span><span class="p">],</span> <span class="n">v_batch_txn_excp_rsn_sk</span><span class="p">,</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_TRGR_STS_FAIL</span><span class="p">,</span>
                                                    <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sla_hour&#39;</span><span class="p">],</span> <span class="n">txn_sts</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_FAIL</span><span class="p">)</span>
                                    <span class="n">ins_batch_txn_dtl</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;INSERT INTO </span><span class="si">{}</span><span class="s1"> ( batch_config_dtl_sk, batch_txn_sk, batch_config_sk, batch_txn_dtl_sts_sk, batch_txn_json_dtl, batch_txn_dtl_excp_rsn_sk)</span>
<span class="s1">                                                        select </span><span class="si">{}</span><span class="s1">, max(batch_txn_sk), </span><span class="si">{config_sk}</span><span class="s1">, </span><span class="si">{txn_sts_fail}</span><span class="s1">, cast(&#39;</span><span class="si">{}</span><span class="s1">&#39; as json ), </span><span class="si">{}</span><span class="s1"> from </span><span class="si">{}</span><span class="s1"> where batch_config_sk = </span><span class="si">{config_sk}</span><span class="s1"> and </span>
<span class="s1">                                                        batch_txn_sts_sk = </span><span class="si">{txn_sts_fail}</span><span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_btd</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_dtl_sk&#39;</span><span class="p">],</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">v_json_msg</span><span class="p">),</span> <span class="n">v_batch_txn_excp_rsn_sk</span><span class="p">,</span> 
                                                                                            <span class="n">v_bt</span><span class="p">,</span> <span class="n">txn_sts_fail</span> <span class="o">=</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_FAIL</span> <span class="p">,</span> <span class="n">config_sk</span><span class="o">=</span><span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sk&#39;</span><span class="p">]</span> <span class="p">)</span>
                                    <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">ins_batch_txn</span><span class="p">)</span>
                                    <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">ins_batch_txn_dtl</span><span class="p">)</span>
                                    <span class="k">continue</span>
                                <span class="k">elif</span> <span class="n">v_batch_txn_excp_rsn_sk</span> <span class="o">==</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_EXCP_RSN_FUT_WIN</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="n">v_batch_txn_excp_rsn_msg</span><span class="p">)</span>
                                    <span class="n">pub_batch_resp</span> <span class="o">=</span> <span class="n">publish_sqs</span><span class="o">.</span><span class="n">pub_sqs</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCHING_QUEUE_NAME</span><span class="p">,</span> <span class="n">v_json_msg</span><span class="p">)</span>                                   
                                    <span class="k">if</span> <span class="n">pub_batch_resp</span><span class="p">[</span><span class="s1">&#39;ResponseMetadata&#39;</span><span class="p">][</span><span class="s1">&#39;HTTPStatusCode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                                        <span class="n">pub_batch_resp_msg</span> <span class="o">=</span> <span class="s1">&#39;Failed to send message back to queue to process in correct order, error_code:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pub_batch_resp</span><span class="p">[</span><span class="s1">&#39;ResponseMetadata&#39;</span><span class="p">][</span><span class="s1">&#39;HTTPStatusCode&#39;</span><span class="p">])</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="n">pub_batch_resp_msg</span><span class="p">)</span>
                                        <span class="c1"># TODO Call Control Service</span>
                                        <span class="n">ctrl_msg</span> <span class="o">=</span> <span class="n">publish_sqs</span><span class="o">.</span><span class="n">gen_msg</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">,</span> <span class="n">v_json_msg</span><span class="p">,</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">QUEUE_ERROR</span><span class="p">,</span> <span class="n">pub_batch_resp_msg</span><span class="p">)</span>
                                        <span class="n">ctrl_resp</span> <span class="o">=</span> <span class="n">publish_sqs</span><span class="o">.</span><span class="n">pub_sqs</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL_QUEUE_NAME</span><span class="p">,</span> <span class="n">ctrl_msg</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">ctrl_resp</span><span class="p">[</span><span class="s1">&#39;ResponseMetadata&#39;</span><span class="p">][</span><span class="s1">&#39;HTTPStatusCode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error while sending message to Control Service queue:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL_QUEUE_NAME</span><span class="p">))</span>
                                    <span class="k">continue</span>
                                <span class="k">elif</span> <span class="n">v_batch_txn_excp_rsn_sk</span> <span class="o">==</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_EXCP_RSN_NE</span><span class="p">:</span>
                                    <span class="c1"># Add code to verify if this table entry is already exists in the this open batch</span>
                                    <span class="c1"># If yes it should raise exception as duplicate message</span>
                                    <span class="n">ins_batch_txn_dtl</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;INSERT INTO </span><span class="si">{}</span><span class="s1"> (</span>
<span class="s1">                                                    batch_config_dtl_sk, batch_txn_sk, batch_config_sk, batch_txn_dtl_sts_sk, batch_txn_json_dtl, batch_txn_dtl_excp_rsn_sk)</span>
<span class="s1">                                                    select </span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, cast(&#39;</span><span class="si">{}</span><span class="s1">&#39; as json ), </span><span class="si">{excp_rsn_ne}</span><span class="s1"> </span>
<span class="s1">                                                    &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_btd</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_dtl_sk&#39;</span><span class="p">],</span>
                                                    <span class="n">max_batch_rec_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_sk&#39;</span><span class="p">],</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sk&#39;</span><span class="p">],</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_COMPLETED</span><span class="p">,</span> 
                                                    <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">v_json_msg</span><span class="p">),</span> <span class="n">excp_rsn_ne</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_EXCP_RSN_NE</span> <span class="p">)</span>
                                    <span class="n">upd_batch_txn</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;update </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                                set batch_txn_recv_file_cnt = batch_txn_recv_file_cnt+1,</span>
<span class="s1">                                                upd_by_user_id = user,</span>
<span class="s1">                                                upd_dttm = current_timestamp</span>
<span class="s1">                                                where batch_txn_sk = </span><span class="si">{}</span>
<span class="s1">                                                &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bt</span><span class="p">,</span> <span class="n">max_batch_rec_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_sk&#39;</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;batch_txn update query&#39;</span><span class="p">,</span> <span class="n">upd_batch_txn</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;batch_txn_dtl insert query&#39;</span><span class="p">,</span> <span class="n">ins_batch_txn_dtl</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                                
                                <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">ins_batch_txn_dtl</span><span class="p">)</span>
                                <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">upd_batch_txn</span><span class="p">)</span>

                                <span class="n">ver_batch_txn_sts_query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;select * from </span><span class="si">{}</span><span class="s1"> where batch_txn_sk = </span><span class="si">{}</span><span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bt</span><span class="p">,</span> <span class="n">max_batch_rec_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_sk&#39;</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;batch verification query: &#39;</span><span class="p">,</span> <span class="n">ver_batch_txn_sts_query</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                                <span class="n">ver_batch_txn_sts_rec_dict</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">ver_batch_txn_sts_query</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Batch verification output dictionary&#39;</span><span class="p">,</span> <span class="n">ver_batch_txn_sts_rec_dict</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">ver_batch_txn_sts_rec_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_expct_file_cnt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ver_batch_txn_sts_rec_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_recv_file_cnt&#39;</span><span class="p">]:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected number of files for this batch config is received. Trigger the target loads :&#39;</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_trgt_scrpt&#39;</span><span class="p">])</span>
                                    <span class="c1"># TODO Add step to verify the status of Target DBX workflow</span>
                                    <span class="n">trigger_res</span> <span class="o">=</span> <span class="n">trigger_wf</span><span class="o">.</span><span class="n">trigger_workflow</span><span class="o">.</span><span class="n">triggerJob</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">DATABRICKS_URL</span><span class="p">,</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">DATABRICKS_AT</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_trgt_scrpt&#39;</span><span class="p">])</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Databricks workflow trigger response :&quot;</span><span class="p">,</span> <span class="n">trigger_res</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">DATABRICKS_SUCC</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">trigger_res</span><span class="p">):</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sucessfully triggerred the workflow:&#39;</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_trgt_scrpt&#39;</span><span class="p">])</span>
                                        <span class="n">mark_batch_txn_completed_query</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;update </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                                        set batch_txn_sts_sk = </span><span class="si">{txn_sts_comp}</span><span class="s1">,</span>
<span class="s1">                                                        batch_txn_trgr_sts_cd_sk = </span><span class="si">{trgr_sts_succ}</span><span class="s1">,</span>
<span class="s1">                                                        batch_txn_excp_rsn_sk = </span><span class="si">{excp_rsn_ne}</span><span class="s1">,</span>
<span class="s1">                                                        upd_by_user_id = user,</span>
<span class="s1">                                                        upd_dttm = current_timestamp</span>
<span class="s1">                                                        where batch_txn_sk = </span><span class="si">{}</span>
<span class="s1">                                                        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bt</span><span class="p">,</span> <span class="n">ver_batch_txn_sts_rec_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_sk&#39;</span><span class="p">],</span> 
                                                                <span class="n">txn_sts_comp</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_COMPLETED</span><span class="p">,</span> 
                                                                <span class="n">trgr_sts_succ</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_TRGR_STS_SUCC</span><span class="p">,</span> <span class="n">excp_rsn_ne</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_EXCP_RSN_NE</span><span class="p">)</span>
                                        <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">mark_batch_txn_completed_query</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to trigger the workflow:&#39;</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_trgt_scrpt&#39;</span><span class="p">],</span> <span class="s1">&#39;marking the batch as failed&#39;</span><span class="p">)</span>
                                        <span class="n">mark_batch_txn_failed_query</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;update </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                                        set batch_txn_sts_sk = </span><span class="si">{txn_sts_fail}</span><span class="s1">,</span>
<span class="s1">                                                        batch_txn_trgr_sts_cd_sk = </span><span class="si">{trgr_sts_fail}</span><span class="s1">,</span>
<span class="s1">                                                        batch_txn_excp_rsn_sk = </span><span class="si">{excp_rsn_ne}</span><span class="s1">,</span>
<span class="s1">                                                        upd_by_user_id = user,</span>
<span class="s1">                                                        upd_dttm = current_timestamp</span>
<span class="s1">                                                        where batch_txn_sk = </span><span class="si">{}</span>
<span class="s1">                                                        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bt</span><span class="p">,</span> <span class="n">ver_batch_txn_sts_rec_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_sk&#39;</span><span class="p">],</span> 
                                                                <span class="n">txn_sts_fail</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_FAIL</span><span class="p">,</span> 
                                                                <span class="n">trgr_sts_fail</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_TRGR_STS_FAIL</span><span class="p">,</span> <span class="n">excp_rsn_ne</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_EXCP_RSN_NE</span><span class="p">)</span>
                                        <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">mark_batch_txn_failed_query</span><span class="p">)</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected number of files are not received yet, so this batch transaction will stay open&#39;</span><span class="p">)</span>

                            <span class="k">elif</span> <span class="n">max_batch_rec_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_sts_sk&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_FAIL</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Its a failed Batch Transaction: raise exception&#39;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid Batch status&#39;</span><span class="p">)</span>
                            

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;There are no existing batch transaction records for this Batchconfig for the source file : </span><span class="si">{}</span>
<span class="s1">                                    Proceeding with first entry to both batch_txn and batch_txn_dtl&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_table_nm</span><span class="p">))</span>
                            
                            <span class="n">ins_batch_txn</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;insert into </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                                ( batch_config_sk, batch_txn_sts_sk, batch_txn_data_extract_dt, batch_txn_wndw_bgn_dt, batch_txn_wndw_end_dt, </span>
<span class="s1">                                                batch_txn_expct_file_cnt, batch_txn_recv_file_cnt, batch_txn_excp_rsn_sk, batch_txn_trgr_sts_cd_sk, batch_txn_max_wait_hours)</span>
<span class="s1">                                                select </span><span class="si">{}</span><span class="s1">, </span><span class="si">{txn_sts_open}</span><span class="s1">, &#39;</span><span class="si">{ext_dt}</span><span class="s1">&#39;,  to_date(&#39;</span><span class="si">{ext_dt}</span><span class="s1">&#39;, &#39;</span><span class="si">{pg_tm_fmt}</span><span class="s1">&#39;) , </span>
<span class="s1">                                                to_date(&#39;</span><span class="si">{ext_dt}</span><span class="s1">&#39;, &#39;</span><span class="si">{pg_tm_fmt}</span><span class="s1">&#39;) + interval &#39;1 sec&#39; * (</span><span class="si">{}</span><span class="s1"> * 3600 -1),</span><span class="si">{}</span><span class="s1">, 1, null, null, </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                                &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bt</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sk&#39;</span><span class="p">],</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_freq_hour&#39;</span><span class="p">],</span>
                                                           <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_cnt&#39;</span><span class="p">],</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sla_hour&#39;</span><span class="p">],</span><span class="n">txn_sts_open</span> <span class="o">=</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_OPEN</span><span class="p">,</span> 
                                                           <span class="n">ext_dt</span><span class="o">=</span><span class="n">v_batch_txn_data_extract_dt</span><span class="p">,</span> <span class="n">pg_tm_fmt</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">EXTRACT_PG_DTTM_FORMAT</span><span class="p">)</span>

                            <span class="n">ins_batch_txn_dtl</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;INSERT INTO </span><span class="si">{}</span><span class="s1"> (</span>
<span class="s1">                                                    batch_config_dtl_sk, batch_txn_sk, batch_config_sk, batch_txn_dtl_sts_sk, batch_txn_json_dtl, batch_txn_dtl_excp_rsn_sk)</span>
<span class="s1">                                                    select </span><span class="si">{}</span><span class="s1">,(select max(batch_txn_sk) from </span><span class="si">{}</span><span class="s1"> where batch_config_sk = </span><span class="si">{}</span><span class="s1"> and batch_txn_sts_sk = </span><span class="si">{txn_sts_open}</span><span class="s1"> ),</span>
<span class="s1">                                                    </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, cast(&#39;</span><span class="si">{}</span><span class="s1">&#39; as json ), </span><span class="si">{excp_rsn_ne}</span><span class="s1"> </span>
<span class="s1">                                                    &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_btd</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_dtl_sk&#39;</span><span class="p">],</span> <span class="n">v_bt</span><span class="p">,</span> 
                                                               <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sk&#39;</span><span class="p">],</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sk&#39;</span><span class="p">],</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_COMPLETED</span><span class="p">,</span> 
                                                               <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">v_json_msg</span><span class="p">),</span> <span class="n">excp_rsn_ne</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_EXCP_RSN_NE</span><span class="p">,</span><span class="n">txn_sts_open</span> <span class="o">=</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_OPEN</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;batch_txn insert query&#39;</span><span class="p">,</span> <span class="n">ins_batch_txn</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;batch_txn_dtl insert query&#39;</span><span class="p">,</span> <span class="n">ins_batch_txn_dtl</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                            <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">ins_batch_txn</span><span class="p">)</span>
                            <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">ins_batch_txn_dtl</span><span class="p">)</span>
                            <span class="n">ver_batch_txn_sts_query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;select * from </span><span class="si">{}</span><span class="s1"> where batch_txn_sk = (select max(batch_txn_sk) from </span><span class="si">{}</span><span class="s1"> where batch_config_sk = </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                            and batch_txn_sts_sk = </span><span class="si">{txn_sts_open}</span><span class="s1"> )</span>
<span class="s1">                                                    &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bt</span><span class="p">,</span> <span class="n">v_bt</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_sk&#39;</span><span class="p">]</span>
                                                               <span class="p">,</span><span class="n">txn_sts_open</span> <span class="o">=</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_OPEN</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;batch verification query: &#39;</span><span class="p">,</span> <span class="n">ver_batch_txn_sts_query</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                            <span class="n">ver_batch_txn_sts_rec_dict</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">ver_batch_txn_sts_query</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Batch verification output dictionary&#39;</span><span class="p">,</span> <span class="n">ver_batch_txn_sts_rec_dict</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">my_debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;____________________________________________________________________________________&#39;</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">ver_batch_txn_sts_rec_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_expct_file_cnt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ver_batch_txn_sts_rec_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_recv_file_cnt&#39;</span><span class="p">]:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected number of files for this batch config is received. Trigger the target loads :&#39;</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_trgt_scrpt&#39;</span><span class="p">])</span>
                                <span class="c1"># TODO Add step to verify the status of Target DBX workflow</span>
                                <span class="n">trigger_res</span> <span class="o">=</span> <span class="n">trigger_wf</span><span class="o">.</span><span class="n">trigger_workflow</span><span class="o">.</span><span class="n">triggerJob</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">DATABRICKS_URL</span><span class="p">,</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">DATABRICKS_AT</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_trgt_scrpt&#39;</span><span class="p">])</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Databricks workflow trigger response :&quot;</span><span class="p">,</span> <span class="n">trigger_res</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">DATABRICKS_SUCC</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">trigger_res</span><span class="p">):</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sucessfully triggerred the workflow:&#39;</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_trgt_scrpt&#39;</span><span class="p">])</span>
                                    <span class="n">mark_batch_txn_completed_query</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;update </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                                    set batch_txn_sts_sk = </span><span class="si">{txn_sts_comp}</span><span class="s1">,</span>
<span class="s1">                                                    batch_txn_trgr_sts_cd_sk = </span><span class="si">{trgr_sts_succ}</span><span class="s1">,</span>
<span class="s1">                                                    batch_txn_excp_rsn_sk = </span><span class="si">{excp_rsn_ne}</span><span class="s1">,</span>
<span class="s1">                                                    upd_by_user_id = user,</span>
<span class="s1">                                                    upd_dttm = current_timestamp</span>
<span class="s1">                                                    where batch_txn_sk = </span><span class="si">{}</span>
<span class="s1">                                                    &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bt</span><span class="p">,</span> <span class="n">ver_batch_txn_sts_rec_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_sk&#39;</span><span class="p">],</span> 
                                                            <span class="n">txn_sts_comp</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_COMPLETED</span><span class="p">,</span> 
                                                            <span class="n">trgr_sts_succ</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_TRGR_STS_SUCC</span><span class="p">,</span> <span class="n">excp_rsn_ne</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_EXCP_RSN_NE</span><span class="p">)</span>
                                    <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">mark_batch_txn_completed_query</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to trigger the workflow:&#39;</span><span class="p">,</span> <span class="n">meta_rec</span><span class="p">[</span><span class="s1">&#39;batch_config_trgt_scrpt&#39;</span><span class="p">],</span> <span class="s1">&#39;marking the batch as failed&#39;</span><span class="p">)</span>
                                    <span class="n">mark_batch_txn_failed_query</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;update </span><span class="si">{}</span><span class="s1"> </span>
<span class="s1">                                                    set batch_txn_sts_sk = </span><span class="si">{txn_sts_fail}</span><span class="s1">,</span>
<span class="s1">                                                    batch_txn_trgr_sts_cd_sk = </span><span class="si">{trgr_sts_fail}</span><span class="s1">,</span>
<span class="s1">                                                    batch_txn_excp_rsn_sk = </span><span class="si">{excp_rsn_ne}</span><span class="s1">,</span>
<span class="s1">                                                    upd_by_user_id = user,</span>
<span class="s1">                                                    upd_dttm = current_timestamp</span>
<span class="s1">                                                    where batch_txn_sk = </span><span class="si">{}</span>
<span class="s1">                                                    &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bt</span><span class="p">,</span> <span class="n">ver_batch_txn_sts_rec_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_txn_sk&#39;</span><span class="p">],</span> 
                                                            <span class="n">txn_sts_fail</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_STS_FAIL</span><span class="p">,</span> 
                                                            <span class="n">trgr_sts_fail</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_TRGR_STS_FAIL</span><span class="p">,</span> <span class="n">excp_rsn_ne</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCH_TXN_EXCP_RSN_NE</span><span class="p">)</span>
                                    <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">mark_batch_txn_failed_query</span><span class="p">)</span>
                                    
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected number of files are not received yet, so this batch transaction will stay open&#39;</span><span class="p">)</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;No active metadata for this source table: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_table_nm</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                    <span class="n">ins_batch_txn</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;insert into </span><span class="si">{}</span><span class="s1"> (</span>
<span class="s1">                                    batch_config_sk, batch_txn_sts_sk, batch_txn_data_extract_dt, batch_txn_wndw_bgn_dt, batch_txn_wndw_end_dt, </span>
<span class="s1">                                    batch_txn_expct_file_cnt, batch_txn_recv_file_cnt, batch_txn_excp_rsn_sk, batch_txn_trgr_sts_cd_sk, batch_txn_max_wait_hours)</span>
<span class="s1">                                    select </span><span class="si">{inv_val}</span><span class="s1">, </span><span class="si">{inv_val}</span><span class="s1">, &#39;</span><span class="si">{}</span><span class="s1">&#39;,  current_date , current_date,</span><span class="si">{inv_val}</span><span class="s1">, </span><span class="si">{inv_val}</span><span class="s1">, </span><span class="si">{inv_val}</span><span class="s1">, </span><span class="si">{inv_val}</span><span class="s1">, </span><span class="si">{inv_val}</span><span class="s1"> </span>
<span class="s1">                                    &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bt</span><span class="p">,</span> <span class="n">v_batch_txn_data_extract_dt</span><span class="p">,</span> <span class="n">inv_val</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">INVALID_VALUE</span><span class="p">)</span>
                    <span class="n">ins_batch_txn_dtl</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;INSERT INTO </span><span class="si">{}</span><span class="s1"> (</span>
<span class="s1">                                        batch_config_dtl_sk, batch_txn_sk, batch_config_sk, batch_txn_dtl_sts_sk, batch_txn_json_dtl, batch_txn_dtl_excp_rsn_sk)</span>
<span class="s1">                                        select </span><span class="si">{inv_val}</span><span class="s1">,(select max(batch_txn_sk) from </span><span class="si">{}</span><span class="s1"> where batch_config_sk = </span><span class="si">{inv_val}</span><span class="s1"> ),</span><span class="si">{inv_val}</span><span class="s1">, </span><span class="si">{inv_val}</span><span class="s1">, cast(&#39;</span><span class="si">{}</span><span class="s1">&#39; as json ), </span><span class="si">{inv_val}</span><span class="s1"> </span>
<span class="s1">                                        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_btd</span><span class="p">,</span> <span class="n">v_bt</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">v_json_msg</span><span class="p">),</span> <span class="n">inv_val</span><span class="o">=</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">INVALID_VALUE</span> <span class="p">)</span>
                    <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">ins_batch_txn</span><span class="p">)</span>
                    <span class="n">pg</span><span class="o">.</span><span class="n">connect_pg</span><span class="o">.</span><span class="n">commit_pg_txn</span><span class="p">(</span><span class="n">ins_batch_txn_dtl</span><span class="p">)</span>
                    <span class="c1"># TODO Call control Service</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Entered information into Transaction tables, ending the process&#39;</span><span class="p">)</span>
                    <span class="n">ctrl_msg</span> <span class="o">=</span> <span class="n">publish_sqs</span><span class="o">.</span><span class="n">gen_msg</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;batch_config_nm&#39;</span><span class="p">:</span> <span class="s1">&#39;No active Batch&#39;</span><span class="p">,</span> <span class="s1">&#39;batch_config_trgt_obj_nm&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">},</span> <span class="n">v_json_msg</span><span class="p">,</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">QUEUE_ERROR</span><span class="p">,</span> <span class="n">err_msg</span><span class="p">)</span>
                    <span class="n">ctrl_resp</span> <span class="o">=</span> <span class="n">publish_sqs</span><span class="o">.</span><span class="n">pub_sqs</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL_QUEUE_NAME</span><span class="p">,</span> <span class="n">ctrl_msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ctrl_resp</span><span class="p">[</span><span class="s1">&#39;ResponseMetadata&#39;</span><span class="p">][</span><span class="s1">&#39;HTTPStatusCode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error while sending message to Control Service queue:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONTROL_QUEUE_NAME</span><span class="p">))</span>
            
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Process Completed for &#39;</span><span class="p">,</span> <span class="n">v_table_nm</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Message in this run:&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">except</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed Processing the message </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_json_msg</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span> <span class="c1"># TODO: add exception handling</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Completed round </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sleeping for : </span><span class="si">{}</span><span class="s1"> seconds, for next message from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="o">.</span><span class="n">CONSUME_SLEEPTIME</span><span class="p">,</span> <span class="n">CONSTANTS</span><span class="o">.</span><span class="n">BATCHING_QUEUE_NAME</span><span class="p">))</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

<span class="c1">#   batching_main()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Print to test batching ECS&quot;</span><span class="p">)</span>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Vignesh Raj.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>